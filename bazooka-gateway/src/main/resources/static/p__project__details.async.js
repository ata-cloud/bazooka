(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{gGkM:function(e,t,a){"use strict";a.r(t);a("14J3");var n=a("BMrR"),r=(a("+L6B"),a("2/Rp")),o=(a("jCWc"),a("kPKH")),s=(a("5NDa"),a("5rEg")),c=a("d6i3"),l=a.n(c),i=a("1l/V"),u=a.n(i),p=a("2Taf"),d=a.n(p),m=a("vZ4D"),h=a.n(m),f=a("l4Ni"),v=a.n(f),E=a("ujKo"),y=a.n(E),g=a("MhPg"),I=a.n(g),k=(a("Znn+"),a("ZTPi")),S=a("q1tI"),b=a.n(S),w=a("y1Nh"),j=a("XfOM"),C=a.n(j),L=a("MuoO"),N=(a("2qtc"),a("kLXV")),x=a("jehZ"),A=a.n(x),F=(a("sRBo"),a("kaz8")),U=(a("T2oS"),a("W9HT")),D=(a("R9oj"),a("ECub")),P=(a("7Kak"),a("9yH6")),T=a("gWZ8"),O=a.n(T),M=(a("IzEo"),a("bx4M")),R=(a("Pwec"),a("CtXQ")),B=(a("miYZ"),a("tsqr")),V=a("p0pE"),q=a.n(V),z=(a("OaEy"),a("2fM7")),G=(a("y8nQ"),a("Vl3Y")),J=(a("iJd5"),a("yP6+")),W=a("cQSq"),_=a.n(W),K=a("oG6R"),Z=a("+n12"),H=(s.a.Search,G.a.Item),X=z.a.Option,Y=s.a.TextArea,Q={labelCol:{xs:{span:24},sm:{span:5}},wrapperCol:{xs:{span:24},sm:{span:16}}},$=new _.a,ee=function(e){function t(e){var a;return d()(this,t),(a=v()(this,y()(t).call(this,e))).onFetchSouce=u()(l.a.mark(function e(){var t,n;return l.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=a.props,n=t.projectId,t.proInfo,(0,t.dispatch)({type:"project/proEnvSoruce",payload:{projectId:n}});case 2:case"end":return e.stop()}},e)})),a.onFetchItem=function(){(0,a.props.dispatch)({type:"env/envList",payload:{}})},a.onFetchDeloyCounts=function(){var e=a.props,t=e.projectId;(0,e.dispatch)({type:"project/deployCounts",payload:{projectId:t,granularity:a.state.granularity}})},a.onGetEnvIds=function(e){var t=[];e&&e.length&&e.map(function(e){t.push(e.envId)}),a.setState({selectedEnvIds:t})},a.onShowModal=function(e){a.setState({type:e,showModal:!0})},a.onCancel=function(){a.setState({showModal:!1,type:""})},a.onSubmit=function(e){var t=a.state,n=(t.searchObj,t.selectedEnvIds),r=a.props.projectId;e.preventDefault(),a.props.form.validateFieldsAndScroll(function(e,t){e||a.setState({submitLoading:!0});var o=t;if(t.envList){var s=[];t.envList.map(function(e){n.indexOf(e)<0&&s.push({envId:e})}),o=q()({},t,{envList:s})}a.onFetchUpdatePro(q()({},o,{projectId:r}))})},a.onFetchUpdatePro=function(){var e=u()(l.a.mark(function e(t){var n;return l.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,K.a.updateProject(t);case 2:n=e.sent,a.setState({submitLoading:!1}),n&&"1"==n.code&&(a.setState({showModal:!1}),B.a.success("修改成功"),a.onFetchInfo(),a.onFetchSouce());case 5:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}(),a.onGranularityChange=function(e){a.setState({granularity:e.target.value})},a.state={type:"",showModal:!1,submitLoading:!1,selectedEnvIds:[],granularity:"WEEK"},a}return I()(t,e),h()(t,[{key:"componentDidMount",value:function(){var e=this.props,t=(e.keys,e.proInfo,e.proEnvSoruce),a=e.envList,n=e.deployCounts;0===t.length?this.onFetchSouce():this.onGetEnvIds(t),a.length||this.onFetchItem(),n.length||this.onFetchDeloyCounts()}},{key:"componentDidUpdate",value:function(e,t){var a=this.state.granularity;t.granularity!==a&&this.onFetchDeloyCounts()}},{key:"componentWillReceiveProps",value:function(e){var t=e.proEnvSoruce;this.props.proEnvSoruce!==t&&this.onGetEnvIds(t)}},{key:"renderBasicInfo",value:function(){var e=this,t=this.props,a=t.proInfo,n=t.userAll,r=Object(Z.e)((n||{}).rows,a.masterUserId);return b.a.createElement(M.a,{title:"项目信息",extra:b.a.createElement(S.Fragment,null,Object(Z.f)()||"USER_PROJECT_MASTER"==a.adminUserRole?b.a.createElement(R.a,{type:"edit",style:{fontSize:20,color:"#1890ff"},onClick:function(){e.onShowModal("basic")}}):null)},b.a.createElement("div",{style:{height:158}},b.a.createElement("div",{className:C.a.flexCenter},b.a.createElement("p",{className:C.a.basicInfoItem},"项目名："),b.a.createElement("p",{className:C.a.flex1},a.projectName)),b.a.createElement("div",{className:C.a.flexCenter},b.a.createElement("p",{className:C.a.basicInfoItem},"项目负责人："),b.a.createElement("p",{className:C.a.flex1},r.realName)),b.a.createElement("div",{className:C.a.flexCenter},b.a.createElement("p",{className:C.a.basicInfoItem},"项目描述："),b.a.createElement("p",{className:C.a.flex1},a.description))))}},{key:"renderEnvSource",value:function(){var e=this,t=this.props,a=t.proEnvSoruce,n=t.proInfo;return b.a.createElement(M.a,{title:"项目资源",extra:b.a.createElement(S.Fragment,null,Object(Z.f)()||"USER_PROJECT_MASTER"==n.adminUserRole?b.a.createElement(R.a,{type:"edit",style:{fontSize:20,color:"#1890ff"},onClick:function(){e.onShowModal("envSource")}}):null)},b.a.createElement("div",{style:{overflowX:"auto"}},b.a.createElement("table",{className:C.a.tableTag},b.a.createElement("tbody",{className:"".concat(C.a.flexCenter," ").concat(C.a.tableBox)},b.a.createElement("tr",null,b.a.createElement("th",{className:"".concat(C.a.gridtitleBg," ").concat(C.a.gridItem)},"可用环境"),b.a.createElement("th",{className:"".concat(C.a.gridtitleBg," ").concat(C.a.gridItem)},"已分配端口范围")),a&&a.map(function(e){return b.a.createElement("tr",{key:e.envId},b.a.createElement("td",{className:C.a.gridItem},e.envName),b.a.createElement("td",{className:C.a.gridItem},"".concat(e.portStart," ~ ").concat(e.portEnd)))})))))}},{key:"renderPubNum",value:function(){var e=this.props,t=e.deployCounts,a=e.deployCountsLoading,n=$.createView().source(O()(t)),r=this.state.granularity;return b.a.createElement(M.a,{title:"各服务发布次数",extra:b.a.createElement(P.a.Group,{buttonStyle:"solid",value:r,onChange:this.onGranularityChange},b.a.createElement(P.a.Button,{value:"WEEK"},"本周"),b.a.createElement(P.a.Button,{value:"MONTH"},"本月"),b.a.createElement(P.a.Button,{value:"YEAR"},"本年")),className:C.a.marginT},b.a.createElement(U.a,{spinning:a},t.length?b.a.createElement(J.Chart,{data:n,forceFit:!0,height:50*t.length,padding:[0,0,0,"15%"]},b.a.createElement(J.Coord,{transpose:!0}),b.a.createElement(J.Axis,{name:"appName",label:{offset:12}}),b.a.createElement(J.Axis,{name:"counts",visible:!1}),b.a.createElement(J.Tooltip,null),b.a.createElement(J.Geom,{type:"interval",position:"appName*counts"})):b.a.createElement(D.a,null)))}},{key:"renderModal",value:function(){var e=this.state,t=e.showModal,a=e.type,r=e.submitLoading,c=e.selectedEnvIds,l=this.props.form,i=l.getFieldDecorator,u=(l.getFieldValue,this.props),p=u.userAll,d=u.proInfo,m=u.envList;return b.a.createElement(S.Fragment,null,b.a.createElement(N.a,{title:"basic"===a?"修改项目信息":"修改项目资源",onCancel:this.onCancel,width:700,confirmLoading:r,onOk:this.onSubmit,visible:t},b.a.createElement(G.a,A()({},Q,{onSubmit:this.onSubmit}),"basic"===a&&b.a.createElement(S.Fragment,null,b.a.createElement(H,{label:"项目名"},i("projectName",{initialValue:d.projectName,rules:[{required:!0,message:"请输入20位以内中文数字字母中横线的组合",pattern:/^[A-Za-z0-9-\u4E00-\u9FA5]{1,20}$/}]})(b.a.createElement(s.a,{placeholder:"请输入项目名"}))),b.a.createElement(H,{label:"负责人"},i("masterUserId",{initialValue:d.masterUserId,rules:[{required:!0,message:"请选择负责人"}]})(b.a.createElement(z.a,{placeholder:"请选择负责人",showSearch:!0,optionFilterProp:"children"},p&&p.rows&&p.rows.map(function(e){return b.a.createElement(X,{value:e.userId,key:e.userId},e.realName)})))),b.a.createElement(H,{label:"描述"},i("description",{initialValue:d.description})(b.a.createElement(Y,{placeholder:"请输入项目描述",rows:4})))),"envSource"===a&&b.a.createElement(S.Fragment,null,b.a.createElement(H,{label:"环境资源"},i("envList",{initialValue:c,rules:[{required:!0,message:"至少选择一个环境资源"}]})(b.a.createElement(F.a.Group,{style:{width:"100%",lineHeight:"unset"}},b.a.createElement(n.a,{type:"flex",align:"middle"},m.map(function(e,t){return b.a.createElement(o.a,{span:11,key:e.id},b.a.createElement(F.a,{value:e.id,disabled:c.indexOf(e.id)>-1},e.name))})))))))))}},{key:"render",value:function(){var e=this.state.showModal;return b.a.createElement(S.Fragment,null,b.a.createElement(n.a,{gutter:48},b.a.createElement(o.a,{md:12,sm:24},this.renderBasicInfo()),b.a.createElement(o.a,{md:12,sm:24},this.renderEnvSource())),this.renderPubNum(),e&&this.renderModal())}}]),t}(b.a.Component),te=G.a.create()(Object(L.connect)(function(e){var t=e.auth,a=e.project,n=e.env,r=e.loading;return{userAll:t.userAll,proInfo:a.proInfo,proEnvSoruce:a.proEnvSoruce,envList:n.envList,deployCounts:a.deployCounts,deployCountsLoading:r.effects["project/deployCounts"]}})(ee)),ae=(a("g9YV"),a("wCAj")),ne=(a("P2fV"),a("NJEC")),re=a("3a4m"),oe=a.n(re),se=(N.a.confirm,z.a.Option),ce=G.a.Item,le=function(e){function t(e){var a;return d()(this,t),(a=v()(this,y()(t).call(this,e))).onFetchDevUserList=function(e){var t=a.props,n=t.projectId;(0,t.dispatch)({type:"project/devUserList",payload:q()({projectId:n},e)})},a.onAddOk=function(e){e.preventDefault(),a.props.form.validateFieldsAndScroll(function(e,t){if(!e){a.setState({userAddLoading:!0});var n=[];t.userIds&&t.userIds.map(function(e){n.push({userId:e.key,userName:e.label})}),a.onAddDecUser(q()({},t,{userIds:n}))}})},a.onAddDecUser=function(){var e=u()(l.a.mark(function e(t){var n,r;return l.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=a.props.projectId,e.next=3,K.a.addDevUser(q()({projectId:n},t));case 3:r=e.sent,a.setState({userAddLoading:!1,showUserAdd:!1}),a.onFetchDevUserList(),r&&"1"==r.code&&B.a.success("添加成功");case 7:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}(),a.onDeleteUser=function(){var e=u()(l.a.mark(function e(t){var n,r;return l.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=a.props.projectId,e.next=3,K.a.deleteDevUser({projectId:n,userId:t.userId});case 3:(r=e.sent)&&"1"==r.code&&(B.a.success("删除成功"),a.onFetchDevUserList());case 5:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}(),a.onDeletePro=function(){a.setState({showDeleteModal:!0})},a.onDeleteProOk=function(e){var t=a.props.proInfo;e&&e.preventDefault(),a.props.form.validateFieldsAndScroll(function(e,n){if(!e){if(t.projectName!==n.name)return void B.a.warning("请输入正确的项目名");a.onDeleteProject(n)}})},a.onDeleteProject=function(){var e=u()(l.a.mark(function e(t){var n,r;return l.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a.setState({deleteProLoading:!0}),n=a.props.projectId,e.next=4,K.a.deleteProject({projectId:n});case 4:r=e.sent,a.setState({deleteProLoading:!1}),r&&"1"==r.code&&(B.a.success("删除成功"),oe.a.goBack());case 7:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}(),a.onTableChange=function(e,t,n){var r=e.current,o=e.pageSize,s=n.order,c=n.field,l=s?{sortValue:"ascend"===s?"asc":"descend"===s?"desc":"",sortName:c||""}:{},i=q()({},l,{pageNo:parseInt(r),pageSize:parseInt(o)});a.onFetchDevUserList(i)},a.onCancel=function(){a.setState({showDeleteModal:!1})},a.onShowUserAdd=function(){a.setState({showUserAdd:!0})},a.onUserAddCancel=function(){a.setState({showUserAdd:!1})},a.state={showDeleteModal:!1,showUserAdd:!1,userAddLoading:!1,deleteProLoading:!1},a}return I()(t,e),h()(t,[{key:"componentDidMount",value:function(){var e=this.props.devUserList;0===Object.getOwnPropertyNames(e).length&&this.onFetchDevUserList()}},{key:"renderDeletePro",value:function(){var e=this.state,t=e.showDeleteModal,a=e.deleteProLoading,n=this.props.form.getFieldDecorator,r=this.props.proInfo;return b.a.createElement(N.a,{visible:t,title:"删除项目",okText:"确认删除",okType:"danger",onOk:this.onDeleteProOk,onCancel:this.onCancel,confirmLoading:a},b.a.createElement("p",null,"请输入项目名“",b.a.createElement("span",{className:C.a.textError},r.projectName),"”确认删除项目"),b.a.createElement("p",null,"删除项目将会删除项目下属的所有服务，相关的服务容器会被关停，代码仓库和镜像会被保留。 删除操作不可逆，请谨慎操作"),b.a.createElement(G.a,{className:C.a.antAdvancedSearchForm,onSubmit:this.onDeleteProOk},b.a.createElement(ce,null,n("name",{rules:[{required:!0,message:"请输入项目名"}]})(b.a.createElement(s.a,null)))))}},{key:"renderUserAdd",value:function(){var e=this.state,t=e.showUserAdd,a=e.userAddLoading,n=this.props.form.getFieldDecorator,r=this.props.userAll;return b.a.createElement(N.a,{title:"添加参与人",visible:t,onOk:this.onAddOk,onCancel:this.onUserAddCancel,confirmLoading:a,maskClosable:!1},b.a.createElement(G.a,{className:C.a.antAdvancedSearchForm,onSubmit:this.onAddOk},b.a.createElement(ce,null,n("userIds",{rules:[{required:!0,message:"请选择参与人"}]})(b.a.createElement(z.a,{mode:"multiple",allowClear:!0,showSearch:!0,optionFilterProp:"children",placeholder:"请选择参与人",labelInValue:!0},r&&r.rows&&r.rows.map(function(e){return b.a.createElement(se,{value:e.userId,key:e.userId},e.realName)}))))))}},{key:"renderTable",value:function(){var e=this,t=this.props,a=t.devUserList,n=t.loading,r=t.proInfo,o=Object(Z.f)()||"USER_PROJECT_MASTER"==r.adminUserRole?{title:"操作",dataIndex:"opera",render:function(t,a){return b.a.createElement("div",null,b.a.createElement(ne.a,{title:"确定删除吗?",onConfirm:function(){return e.onDeleteUser(a)},okText:"确定",cancelText:"取消"},b.a.createElement("a",null,"删除")))}}:{},s=[{title:"用户名",dataIndex:"username"},{title:"全名",dataIndex:"realName"},{title:"邮箱",dataIndex:"email"},q()({},o)];return b.a.createElement(ae.a,{columns:s,dataSource:a.rows||[],onChange:this.onTableChange,loading:n,pagination:{total:a.totalCount||0,showTotal:function(e,t){return"共".concat(a.totalCount||0,"条，当前").concat(a.pageNum?a.pageNum:1,"/").concat(a.totalPage?a.totalPage:1,"页")},current:a.pageNum?a.pageNum:1,pageSize:a.pageSize?a.pageSize:10},rowKey:function(e){return e.userId}})}},{key:"render",value:function(){var e=this.state,t=e.showDeleteModal,a=e.showUserAdd,n=this.props.proInfo;return b.a.createElement(S.Fragment,null,b.a.createElement(M.a,{title:"项目参与人列表",extra:b.a.createElement(S.Fragment,null,Object(Z.f)()||"USER_PROJECT_MASTER"==n.adminUserRole?b.a.createElement(r.a,{type:"primary",onClick:this.onShowUserAdd},"添加参与人"):null)},this.renderTable()),Object(Z.f)()&&b.a.createElement(M.a,{title:"删除项目",className:C.a.marginT,hoverable:!0},b.a.createElement("p",null,"删除项目将会删除项目下属的所有服务，相关的服务容器会被关停，代码仓库和镜像会被保留。 删除操作不可逆，请谨慎操作"),b.a.createElement(r.a,{type:"danger",onClick:this.onDeletePro},"删除项目")),t&&this.renderDeletePro(),a&&this.renderUserAdd())}}]),t}(b.a.Component),ie=G.a.create()(Object(L.connect)(function(e){var t=e.project,a=e.auth,n=e.loading;return{devUserList:t.devUserList,userAll:a.userAll,proInfo:t.proInfo,loading:n.effects["project/devUserList"]}})(le)),ue=a("cBhy"),pe=a("Onig"),de=function(e){function t(e){var a;return d()(this,t),(a=v()(this,y()(t).call(this,e))).onFetchList=function(e){var t=a.props,n=t.projectId;t.appList;(0,t.dispatch)({type:"service/appList",payload:q()({projectId:n},e)})},a.onRouteTo=function(e,t){oe.a.push({pathname:e,query:{projectId:t.projectId,appId:t.id}})},a.onTop=function(){var e=u()(l.a.mark(function e(t){var n,r;return l.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t.orderId>0)){e.next=7;break}return e.next=3,pe.a.topDelete({appId:t.id});case 3:(n=e.sent)&&"1"===n.code&&(B.a.success("取消成功"),a.onFetchList()),e.next=11;break;case 7:return e.next=9,pe.a.topAdd({appId:t.id});case 9:(r=e.sent)&&"1"===r.code&&(B.a.success("置顶成功"),a.onFetchList());case 11:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}(),a.state={list:[{},{},{},{}],projectId:void 0},a}return I()(t,e),h()(t,[{key:"componentDidMount",value:function(){this.props.appList.length||this.onFetchList()}},{key:"componentWillReceiveProps",value:function(e){var t=e.keyword;this.props.keyword!==e.keyword&&this.onFetchList({keyword:t})}},{key:"renderList",value:function(){var e=this,t=this.props.appList;return b.a.createElement(S.Fragment,null,b.a.createElement(n.a,{gutter:24},t&&t.length?t.map(function(t,a){return b.a.createElement(o.a,{span:8,key:a},b.a.createElement(ue.a,{item:q()({},t,{index:a}),toTop:function(){return e.onTop(t)},onItemClick:function(){return e.onRouteTo("/service/detail",t)}}))}):b.a.createElement("div",{className:C.a.marginT},b.a.createElement(D.a,null))))}},{key:"render",value:function(){var e=this.props.loading;return b.a.createElement(S.Fragment,null,b.a.createElement(U.a,{spinning:e},this.renderList()))}}]),t}(b.a.Component),me=Object(L.connect)(function(e){var t=e.service,a=e.loading;return{appList:t.appList,loading:a.effects["service/appList"]}})(de),he=(k.a.TabPane,function(e){function t(e){var a;return d()(this,t),(a=v()(this,y()(t).call(this,e))).onFetchInfo=function(){var e=u()(l.a.mark(function e(t){return l.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:(0,a.props.dispatch)({type:"project/proInfo",payload:{projectId:t}});case 2:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}(),a.onTabChange=function(e){a.state.keys;a.setState({key:e})},a.onSearch=function(e){a.setState({keyword:e})},a.onAddServixe=function(){var e=a.props.proInfo;oe.a.push({pathname:"/service/add",query:{projectId:e.id}})},a.state={key:"1",projectId:void 0,tabList:[{key:"1",tab:"服务列表"},{key:"2",tab:"项目信息"},{key:"3",tab:"项目配置"}],keys:[],keyword:""},a}return I()(t,e),h()(t,[{key:"componentDidMount",value:function(){var e=this.props.location.query||{};this.setState({projectId:e.projectId}),this.onFetchInfo(e.projectId)}},{key:"componentWillUnmount",value:function(){var e=this.props.dispatch;e({type:"project/clearData",payload:{proInfo:{},proEnvSoruce:[],devUserList:{},deployCounts:[]}}),e({type:"service/clearData",payload:{appList:[]}})}},{key:"render",value:function(){var e=this.state,t=e.key,a=e.projectId,c=e.tabList,l=(e.keys,e.keyword),i=this.props.proInfo;return b.a.createElement(S.Fragment,null,a&&b.a.createElement(w.PageHeaderWrapper,{title:i.projectName,content:b.a.createElement(S.Fragment,null,"1"==t?b.a.createElement(n.a,{type:"flex",justify:"end",align:"middle"},b.a.createElement(o.a,null,b.a.createElement(s.a.Search,{placeholder:"搜索服务",onSearch:this.onSearch})),b.a.createElement(o.a,null,b.a.createElement(r.a,{className:C.a.marginL,type:"primary",onClick:this.onAddServixe},"+ 新增服务"))):b.a.createElement(n.a,{type:"flex",justify:"end",align:"middle"},b.a.createElement(o.a,null,b.a.createElement(s.a,{style:{visibility:"hidden"}})))),tabList:c,onTabChange:this.onTabChange,tabActiveKey:t},"1"===t&&b.a.createElement(me,{projectId:a,keyword:l}),"2"===t&&b.a.createElement(te,{projectId:a}),"3"===t&&b.a.createElement(ie,{projectId:a})))}}]),t}(b.a.Component));t.default=Object(L.connect)(function(e){var t=e.project;e.service;return{proInfo:t.proInfo}})(he)}}]);